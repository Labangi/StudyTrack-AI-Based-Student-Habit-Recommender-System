<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - StudyTrack</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-bottom: 50px;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: white;
            font-size: 28px;
        }

        .header-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .header-right a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            transition: all 0.3s;
        }

        .header-right a:hover {
            background: white;
            color: #667eea;
        }

        .user-info {
            text-align: right;
            color: white;
        }

        .user-info p {
            font-size: 14px;
            opacity: 0.9;
        }

        .btn-logout {
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid white;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: white;
            color: #667eea;
        }

        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 25px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: white;
            color: #667eea;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            transition: border 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #results {
            display: none;
        }

        .risk-assessment {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .risk-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .risk-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .risk-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 16px;
        }

        .risk-low {
            background: #d4edda;
            color: #155724;
        }

        .risk-moderate {
            background: #fff3cd;
            color: #856404;
        }

        .risk-high {
            background: #f8d7da;
            color: #721c24;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .metric-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .metric-target {
            font-size: 12px;
            color: #10b981;
            margin-top: 5px;
        }

        .chart-container {
            height: 300px;
            margin-bottom: 30px;
        }

        .recommendations {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .recommendations h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .recommendations ul {
            list-style: none;
            padding: 0;
        }

        .recommendations li {
            padding: 12px;
            background: white;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .history-item {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .history-date {
            font-size: 18px;
            font-weight: 600;
            color: #667eea;
        }

        .history-risk {
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 13px;
            font-weight: 600;
        }

        .history-habits {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .history-habit {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .history-habit-label {
            font-size: 11px;
            color: #666;
            margin-bottom: 3px;
        }

        .history-habit-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .history-recommendations {
            background: #f0f2ff;
            padding: 15px;
            border-radius: 10px;
        }

        .history-recommendations h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 15px;
        }

        .history-rec-item {
            background: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            font-size: 14px;
            border-left: 3px solid #667eea;
        }

        .priority-high {
            border-left-color: #ef4444;
        }

        .priority-medium {
            border-left-color: #fbbf24;
        }

        .priority-low {
            border-left-color: #10b981;
        }

        .no-history {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.8);
        }

        .no-history h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .star {
            font-size: 40px;
            cursor: pointer;
            color: #ddd;
            transition: color 0.2s;
        }

        .star:hover {
            color: #fbbf24;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>üéì Student Dashboard</h1>
        <div class="header-right">
            <a href="/student/progress">üìà View Progress</a>
            <div class="user-info">
                <p><strong id="studentName">Student</strong></p>
                <p>Student Dashboard</p>
            </div>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('log')">üìù Log Daily Habits</button>
            <button class="tab" onclick="showTab('history')">üìÖ Recommendation History</button>
        </div>

        <!-- Tab 1: Log Habits -->
        <div id="logTab" class="tab-content active">
            <div class="card">
                <h2>üìä Log Your Daily Habits</h2>
                <p style="color: #666; margin-bottom: 20px;">Track your daily habits to get personalized AI-powered
                    recommendations</p>

                <form id="habitForm">
                    <input type="hidden" id="studentId" value="1">

                    <div class="form-grid">
                        <div class="form-group">
                            <label>üìñ Study Hours/Day</label>
                            <input type="number" id="studyHours" placeholder="e.g., 3.5" step="0.1" required>
                        </div>

                        <div class="form-group">
                            <label>üò¥ Sleep Hours/Night</label>
                            <input type="number" id="sleepHours" placeholder="e.g., 7" step="0.1" required>
                        </div>

                        <div class="form-group">
                            <label>üìÖ Attendance Percentage</label>
                            <input type="number" id="attendance" placeholder="e.g., 85" min="0" max="100" required>
                        </div>

                        <div class="form-group">
                            <label>üì± Social Media Hours/Day</label>
                            <input type="number" id="socialMedia" placeholder="e.g., 2" step="0.1" required>
                        </div>

                        <div class="form-group">
                            <label>üí™ Exercise Frequency (times/week)</label>
                            <input type="number" id="exercise" placeholder="e.g., 3" min="0" max="7" required>
                        </div>

                        <div class="form-group">
                            <label>üò∞ Stress Level (1-10)</label>
                            <input type="number" id="stress" placeholder="e.g., 5" min="1" max="10" required>
                        </div>

                        <div class="form-group">
                            <label>üéØ Motivation Level (1-10)</label>
                            <input type="number" id="motivation" placeholder="e.g., 7" min="1" max="10" required>
                        </div>

                        <div class="form-group">
                            <label>üß† Mental Health Rating (1-10)</label>
                            <input type="number" id="mentalHealth" placeholder="e.g., 6" min="1" max="10" required>
                        </div>
                    </div>

                    <button type="submit" class="btn">Get My Personalized Plan üöÄ</button>
                </form>
            </div>

            <!-- Results -->
            <div id="results">
                <div class="card">
                    <h2>üìä Your Risk Assessment</h2>
                    <div class="risk-assessment">
                        <div class="risk-card">
                            <h3>Risk Level</h3>
                            <span id="riskBadge" class="risk-badge">-</span>
                        </div>
                        <div class="risk-card">
                            <h3>Dropout Probability</h3>
                            <div style="font-size: 28px; font-weight: bold; color: #667eea;" id="dropoutProb">-</div>
                        </div>
                        <div class="risk-card">
                            <h3>Student Cluster</h3>
                            <div style="font-size: 24px; font-weight: bold; color: #667eea;" id="cluster">-</div>
                        </div>
                        <div class="risk-card">
                            <h3>Priority Score</h3>
                            <div style="font-size: 28px; font-weight: bold; color: #667eea;" id="priorityScore">-</div>
                        </div>
                    </div>

                    <h2>üìà Current vs Target Metrics</h2>
                    <div id="metricsGrid" class="metrics-grid"></div>

                    <div class="chart-container">
                        <canvas id="metricsChart"></canvas>
                    </div>

                    <div class="recommendations">
                        <h3>üí° AI-Powered Personalized Recommendations</h3>
                        <ul id="recommendations"></ul>
                    </div>

                    <div class="recommendations">
                        <h3>üìö Recommended Study Techniques for You</h3>
                        <div id="studyTechniques"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: History -->
        <div id="historyTab" class="tab-content">
            <div class="card">
                <h2>üìÖ Your Recommendation History</h2>
                <p style="color: #666; margin-bottom: 20px;">View your daily habits and AI recommendations over time</p>
                <div id="historyContent">
                    <div style="text-align: center; padding: 40px; color: #999;">
                        Loading history...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="modal">
        <div class="modal-content">
            <div style="text-align: center; margin-bottom: 30px;">
                <h2 style="color: #667eea; margin-bottom: 10px;">üìù Share Your Feedback</h2>
                <p style="color: #666;">Help us improve your experience and assist other students</p>
            </div>

            <form id="feedbackForm">
                <div style="margin-bottom: 25px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">How helpful were
                        the recommendations?</label>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <span class="star" data-rating="1" onclick="setRating(1)"
                            style="font-size: 30px; cursor: pointer; color: #ddd;">‚òÖ</span>
                        <span class="star" data-rating="2" onclick="setRating(2)"
                            style="font-size: 30px; cursor: pointer; color: #ddd;">‚òÖ</span>
                        <span class="star" data-rating="3" onclick="setRating(3)"
                            style="font-size: 30px; cursor: pointer; color: #ddd;">‚òÖ</span>
                        <span class="star" data-rating="4" onclick="setRating(4)"
                            style="font-size: 30px; cursor: pointer; color: #ddd;">‚òÖ</span>
                        <span class="star" data-rating="5" onclick="setRating(5)"
                            style="font-size: 30px; cursor: pointer; color: #ddd;">‚òÖ</span>
                    </div>
                    <input type="hidden" id="feedbackRating" required>
                </div>

                <div style="margin-bottom: 25px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">Have you seen
                        improvement in your studies?</label>
                    <select id="improvementSeen" required
                        style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 15px;">
                        <option value="">Select...</option>
                        <option value="Significant Improvement">Yes, Significant Improvement</option>
                        <option value="Some Improvement">Yes, Some Improvement</option>
                        <option value="No Change Yet">No Change Yet</option>
                        <option value="Too Early to Tell">Too Early to Tell</option>
                    </select>
                </div>

                <div style="margin-bottom: 25px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">Personalized
                        Feedback:</label>
                    <textarea id="feedbackText" required placeholder="What did you find most helpful? Any suggestions?"
                        style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 15px; min-height: 120px; font-family: inherit;"></textarea>
                </div>

                <div style="margin-bottom: 25px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="wouldRecommend" style="width: 20px; height: 20px; cursor: pointer;">
                        <span style="color: #333;">I would recommend this system to other students</span>
                    </label>
                </div>

                <div style="display: flex; gap: 15px;">
                    <button type="submit"
                        style="flex: 1; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">
                        Submit Feedback
                    </button>
                    <button type="button" onclick="closeFeedbackModal()"
                        style="flex: 1; padding: 15px; background: #e0e0e0; color: #666; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer;">
                        Skip for Now
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentPredictionId = null;
        let selectedRating = 0;
        let currentDailyHabitId = null;

        function setRating(rating) {
            selectedRating = rating;
            document.getElementById('feedbackRating').value = rating;

            document.querySelectorAll('.star').forEach((star, index) => {
                if (index < rating) {
                    star.style.color = '#fbbf24';
                } else {
                    star.style.color = '#ddd';
                }
            });
        }

        function showFeedbackModal(predictionId) {
            currentPredictionId = predictionId;
            document.getElementById('feedbackModal').style.display = 'block';

            // Fix: Reset stars validation (visual only) on open, though ideally they should be empty.
            // The issue user reported is that they are already filled. 
            // We ensure we reset them every time we close, so when we open they are fresh.
            // Also explicitly reset here to be safe.
            setRating(0);
        }

        function closeFeedbackModal() {
            document.getElementById('feedbackModal').style.display = 'none';
            document.getElementById('feedbackForm').reset();
            selectedRating = 0;
            document.querySelectorAll('.star').forEach(star => {
                star.style.color = '#ddd';
            });
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

            // Show selected tab
            if (tabName === 'log') {
                document.getElementById('logTab').classList.add('active');
                document.querySelectorAll('.tab')[0].classList.add('active');
            } else if (tabName === 'history') {
                document.getElementById('historyTab').classList.add('active');
                document.querySelectorAll('.tab')[1].classList.add('active');
                loadRecommendationHistory();
            }
        }

        async function loadRecommendationHistory() {
            const historyContent = document.getElementById('historyContent');
            const user = JSON.parse(localStorage.getItem('user') || '{}');

            if (!user.student_id) {
                historyContent.innerHTML = '<div style="text-align: center; padding: 40px;">Please login to view history</div>';
                return;
            }

            historyContent.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">Loading history...</div>';

            try {
                const response = await fetch(`/api/student/recommendation-history/${user.student_id}`);
                const data = await response.json();

                if (data.status === 'success' && data.history && data.history.length > 0) {
                    historyContent.innerHTML = data.history.map(day => `
                        <div class="history-item">
                            <div class="history-header">
                                <div class="history-date">üìÖ ${new Date(day.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                                ${day.risk_level ? `<div class="history-risk risk-${day.risk_level.toLowerCase()}">${day.risk_level} Risk</div>` : ''}
                            </div>
                            
                            <div class="history-habits">
                                <div class="history-habit">
                                    <div class="history-habit-label">Study Hours</div>
                                    <div class="history-habit-value">${day.habits.study_hours}h</div>
                                </div>
                                <div class="history-habit">
                                    <div class="history-habit-label">Sleep Hours</div>
                                    <div class="history-habit-value">${day.habits.sleep_hours}h</div>
                                </div>
                                <div class="history-habit">
                                    <div class="history-habit-label">Attendance</div>
                                    <div class="history-habit-value">${day.habits.attendance}%</div>
                                </div>
                                <div class="history-habit">
                                    <div class="history-habit-label">Social Media</div>
                                    <div class="history-habit-value">${day.habits.social_media}h</div>
                                </div>
                                <div class="history-habit">
                                    <div class="history-habit-label">Exercise</div>
                                    <div class="history-habit-value">${day.habits.exercise}x</div>
                                </div>
                            </div>
                            
                            ${day.recommendations.length > 0 ? `
                                <div class="history-recommendations">
                                    <h4>üí° Recommendations (${day.total_recommendations})</h4>
                                    ${day.recommendations.map(rec => `
                                        <div class="history-rec-item priority-${rec.priority.toLowerCase()}">
                                            <strong>${rec.category}</strong> [${rec.priority}]: ${rec.message}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p style="color: #999; font-style: italic;">No recommendations for this day</p>'}
                        </div>
                    `).join('');
                } else {
                    historyContent.innerHTML = `
                        <div class="no-history">
                            <h3>üì≠ No History Yet</h3>
                            <p>Start logging your daily habits to see your recommendation history here!</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading history:', error);
                historyContent.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Error loading history</div>';
            }
        }

        document.getElementById('habitForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (!user.student_id) {
                alert('Please login first');
                window.location.href = '/login';
                return;
            }

            const studyHours = parseFloat(document.getElementById('studyHours').value);
            const sleepHours = parseFloat(document.getElementById('sleepHours').value);
            const attendance = parseFloat(document.getElementById('attendance').value);
            const socialMedia = parseFloat(document.getElementById('socialMedia').value);
            const exercise = parseInt(document.getElementById('exercise').value);
            const stress = parseInt(document.getElementById('stress').value);
            const motivation = parseInt(document.getElementById('motivation').value);
            const mentalHealth = parseInt(document.getElementById('mentalHealth').value);

            // Calculate derived metrics
            const timeManagement = (motivation + mentalHealth) / 2;
            const extracurricularParticipation = exercise > 2 ? 1 : 0;
            const financialStress = stress > 6 ? 1 : 0;
            const sleepQuality = sleepHours >= 7 ? 8 : 5;
            const screenTime = socialMedia + 2;
            const physicalActivity = exercise * 45;
            const classParticipation = attendance / 10;
            const readingHabits = studyHours / 2;

            const data = {
                student_id: user.student_id,
                study_hours: studyHours,
                sleep_hours: sleepHours,
                attendance_percentage: attendance,
                social_media_hours: socialMedia,
                exercise_frequency: exercise,
                stress_level: stress,
                motivation_level: motivation,
                mental_health_rating: mentalHealth,
                time_management_score: timeManagement,
                extracurricular_participation: extracurricularParticipation,
                family_support: 7,
                relationship_status: 0,
                financial_stress: financialStress,
                part_time_job: 0,
                commute_time: 1.5,
                study_environment_quality: 7,
                peer_influence: 6,
                teacher_student_relationship: 7,
                bullying_experience: 0,
                diet_quality: 6,
                screen_time_hours: screenTime,
                physical_activity_minutes: physicalActivity,
                caffeine_intake: 1,
                smoking: 0,
                alcohol_consumption: 0,
                sleep_quality: sleepQuality,
                chronic_illness: 0,
                medication_use: 0,
                study_technique: 2,
                note_taking_skills: 6,
                test_anxiety: stress,
                previous_gpa: 3.0,
                exam_score: 75,
                assignment_completion_rate: attendance,
                class_participation: classParticipation,
                tutor_sessions_attended: 1,
                online_resource_usage: 4,
                reading_habits: readingHabits,
                writing_skills: 6,
                math_skills: 6,
                science_skills: 6,
                career_goals_clarity: motivation,
                internship_experience: 0,
                scholarship_status: 0,
                parent_education_level: 2,
                number_of_siblings: 2,
                living_situation: 1,
                campus_involvement: extracurricularParticipation,
                club_memberships: exercise > 3 ? 2 : 1,
                volunteer_hours: 2,
                leadership_roles: 0,
                internet_access_quality: 8,
                device_ownership: 1
            };

            try {
                const btn = document.querySelector('.btn');
                btn.innerHTML = 'Analyzing... ‚è≥';
                btn.disabled = true;

                // Step 1: Predict Dropout
                const predResponse = await fetch('/api/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const predData = await predResponse.json();

                // Save habit id if returned
                if (predData.daily_habit_id) {
                    currentDailyHabitId = predData.daily_habit_id;
                }

                // Step 2: Get Recommendations
                const recData = {
                    student_id: user.student_id,
                    cluster: predData.cluster,
                    daily_habit_id: currentDailyHabitId,
                    study_hours: studyHours,
                    sleep_hours: sleepHours,
                    attendance_percentage: attendance,
                    social_media_hours: socialMedia,
                    exercise_frequency: exercise,
                    risk_level: predData.risk_level,
                    dropout_probability: predData.dropout_probability,
                    stress_level: stress,
                    motivation_level: motivation
                };

                const recResponse = await fetch('/api/recommend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(recData)
                });

                const recommendations = await recResponse.json();

                displayResults(predData, recommendations);

                btn.innerHTML = 'Get My Personalized Plan üöÄ';
                btn.disabled = false;

            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error: ' + error.message);
                const btn = document.querySelector('.btn');
                btn.innerHTML = 'Get My Personalized Plan üöÄ';
                btn.disabled = false;
            }
        });

        function displayResults(prediction, recommendations) {
            document.getElementById('results').style.display = 'block';
            // Scroll to results
            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });

            currentPredictionId = prediction.prediction_id || null;

            const riskBadge = document.getElementById('riskBadge');
            riskBadge.textContent = prediction.risk_level;
            riskBadge.className = 'risk-badge risk-' + prediction.risk_level.toLowerCase();

            document.getElementById('dropoutProb').textContent = (prediction.dropout_probability * 100).toFixed(1) + '%';
            document.getElementById('cluster').textContent = 'Cluster ' + prediction.cluster;
            document.getElementById('priorityScore').textContent = (prediction.priority_score || 0) + '/15';

            const metricsGrid = document.getElementById('metricsGrid');
            metricsGrid.innerHTML = '';

            // Use targets if available, otherwise defaults
            const current = recommendations.current || {};
            const targets = recommendations.targets || {};

            const metrics = [
                { label: 'Study Hours', current: current.study_hours || 0, target: targets.study_hours || 0 },
                { label: 'Sleep Hours', current: current.sleep_hours || 0, target: targets.sleep_hours || 0 },
                { label: 'Attendance', current: current.attendance || 0, target: targets.attendance || 0 },
                { label: 'Social Media', current: current.social_media || 0, target: targets.social_media || 0 },
                { label: 'Exercise', current: current.exercise || 0, target: targets.exercise || 0 }
            ];

            metrics.forEach(m => {
                const card = document.createElement('div');
                card.className = 'metric-card';
                card.innerHTML = `
                    <div class="metric-label">${m.label}</div>
                    <div class="metric-value">${m.current}</div>
                    <div class="metric-target">Target: ${m.target}</div>
                `;
                metricsGrid.appendChild(card);
            });

            const existingChart = Chart.getChart('metricsChart');
            if (existingChart) {
                existingChart.destroy();
            }

            const ctx = document.getElementById('metricsChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: metrics.map(m => m.label),
                    datasets: [
                        {
                            label: 'Current',
                            data: metrics.map(m => parseFloat(m.current)),
                            backgroundColor: '#667eea'
                        },
                        {
                            label: 'Target',
                            data: metrics.map(m => parseFloat(m.target)),
                            backgroundColor: '#10b981'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            const recList = document.getElementById('recommendations');
            recList.innerHTML = '';

            const recs = recommendations.recommendations || [];
            if (recs.length > 0) {
                recs.forEach(rec => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${rec.category || 'Tip'}</strong> [${rec.priority || 'Medium'}]: ${rec.message || ''}`;
                    recList.appendChild(li);
                });
            } else {
                recList.innerHTML = '<li>‚úÖ Great job! You\'re on track with your goals.</li>';
            }

            const techDiv = document.getElementById('studyTechniques');
            techDiv.innerHTML = '';

            const techniques = recommendations.study_techniques || [];
            if (techniques.length > 0) {
                techniques.slice(0, 3).forEach(tech => {
                    techDiv.innerHTML += `
                        <div style="margin-bottom: 20px; padding: 15px; background: #f9fafb; border-radius: 8px; border-left: 4px solid #667eea;">
                            <h3 style="color: #667eea; margin: 0 0 10px 0;">${tech.name}</h3>
                            <p style="margin: 5px 0;"><strong>üìñ What:</strong> ${tech.description}</p>
                            <p style="margin: 5px 0;"><strong>üéØ How:</strong> ${tech.how_to}</p>
                            <p style="margin: 5px 0;"><strong>‚è∞ When:</strong> ${tech.frequency}</p>
                        </div>
                    `;
                });
            }

            // Show feedback modal later
            setTimeout(() => {
                showFeedbackModal(currentPredictionId);
            }, 5000);
        }

        function logout() {
            localStorage.removeItem('user');
            window.location.href = '/login';
        }

        document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const user = JSON.parse(localStorage.getItem('user') || '{}');

            if (!user.student_id) {
                alert('‚ùå Session error: Student ID not found. Please log in again.');
                window.location.href = '/login';
                return;
            }

            const feedbackData = {
                student_id: user.student_id,
                prediction_id: currentPredictionId,
                rating: selectedRating,
                feedback_text: document.getElementById('feedbackText').value,
                improvement_seen: document.getElementById('improvementSeen').value,
                would_recommend: document.getElementById('wouldRecommend').checked ? 1 : 0
            };

            if (!selectedRating) {
                alert('‚≠ê Please select a rating by clicking on the stars');
                return;
            }

            try {
                const response = await fetch('/api/feedback/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(feedbackData)
                });

                const data = await response.json();

                if (data.status === 'success') {
                    // alert('‚úÖ ' + data.message); // Removed alert for smoother UX
                    closeFeedbackModal();
                } else {
                    alert('‚ùå ' + data.message);
                }
            } catch (error) {
                console.error('Error submitting feedback:', error);
                alert('‚ùå Error submitting feedback. Please try again.');
            }
        });

        window.onload = () => {
            const user = JSON.parse(localStorage.getItem('user') || '{}');

            // Check if user exists and has a valid numeric student_id
            // The previous bug caused student_id to be "student" (string) or undefined
            if (!user.student_id || isNaN(user.student_id)) {
                console.log('Invalid session or no user, redirecting to login');
                localStorage.removeItem('user');
                window.location.href = '/login';
                return;
            }

            document.getElementById('studentName').textContent = user.fullname || user.username || 'Student';
            document.getElementById('studentId').value = user.student_id;
        };
    </script>
</body>

</html>